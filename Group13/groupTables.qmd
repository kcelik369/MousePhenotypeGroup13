---
title: "groupingTables"
format: html
---

## FILE USAGE
- This file cleans/formats the diseases table, and modifies the table to obey first normal form by creating a new table to hold the lists of OMIM IDs.

```{r}
library(data.table)
library(dplyr)
library(readr)
library(stringr)
```

```{r}
# load diseases table
base_path = "~/Documents/GitHub/MousePhenotypeGroup13/"
disease_filepath = "originals/Disease_information.csv"
disease_df = fread(str_c(base_path, disease_filepath))
head(disease_df,3)
```

```{r}
# create a method to convert string fields to numbers
my_cut = function (my_str, my_start=1) {
  str_len = nchar(my_str)
  cut_str = as.integer(substr(my_str, my_start, str_len))
  return (cut_str)
}

# this above function works on the below fields, we have included an explanation
# of why we do not use it in our discussion
# disease_df$`DO Disease ID` = sapply(disease_df$`DO Disease ID`, my_cut, my_start=6)
# disease_df$`Mouse MGI ID` = sapply(disease_df$`Mouse MGI ID`, my_cut, my_start=5)
```

```{r}
# to obey first normal form principle of databases, move list of omim_ids
# into its own table linking an omim_id to an omim_group_id
omim_group_col_names = c("group_id", "omim_id")
omim_group_df = data.frame(matrix(nrow = 0, ncol = 2))
colnames(omim_group_df) = omim_group_col_names
omim_group_id = 1:nrow(disease_df)

# again here, we would use my_cut() method to clean OMIM IDs, but do not
# for reasons explained in the discussion
disease_df = cbind(disease_df, omim_group_id) # create the new column
for (i in 1:nrow(disease_df)) {
  # get list of omim_ids for each row
  curr_omim_ids = disease_df[i,]$`OMIM IDs`
  
  # split on the | character, requires regex; get list of split strings
  omim_list = as.list(strsplit(curr_omim_ids, "\\|", perl=TRUE)[[1]])
  
  # create a row in new table for each of the split strings
  for (j in 1:length(omim_list)){
    # this is where we would trim the OMIM ID strings
    omim_group_df[nrow(omim_group_df)+1,] = c(disease_df[i,]$omim_group_id, omim_list[j])
  }
}

disease_df = disease_df[ ,':='(`OMIM IDs`=NULL)] # drop the old omim list column
head(disease_df,3)
```

```{r}
# rename columns for sql convenience
colnames(disease_df) = c("disease_id", "disease_name", "mouse_mgi_id", "omim_group_id")
head(disease_df,2)
```

```{r}
# write out the OMIM groups table
output_file = "output/omim_groups.csv"
fwrite(omim_group_df, str_c(base_path, output_file))
head(omim_group_df)
```

```{r}
# sanity check to ensure no duplicates are generated 
disease = "Aicardi-Goutieres syndrome" # pick a disease
group = disease_df[disease_df$disease_name==disease,]$omim_group_id[1] # get its group id
omims = omim_group_df[omim_group_df$group_id == group,] # check the related OMIM IDs
duplicated(omims) # want to see no TRUE values
```

```{r}
# write out the cleaned diseases table
output_file3 = "output/diseases_cleaned.csv"
fwrite(disease_df, str_c(base_path, output_file3))
head(disease_df)
```

```{r}
# confirm disease_id cannot be used as primary key in SQL
repeats_df = disease_df[duplicated(disease_df$disease_id),]
head(repeats_df)
```
